<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â¤ï¸ ìš°ë¦¬ë§Œì˜ ì¿ í°ë¶ â¤ï¸</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* í™”ì´íŠ¸ í…Œë§ˆì— ì–´ìš¸ë¦¬ëŠ” ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
            --primary-accent: #FF6B6B; /* í¬ì¸íŠ¸ ìƒ‰ìƒ (ì‚¬ë‘/ê°•ì¡°) */
            --secondary-accent: #4ECDC4; /* ë³´ì¡° í¬ì¸íŠ¸ ìƒ‰ìƒ (ì‚°ëœ»í•¨) */
            --background-light: #F8F8F8; /* ë°ì€ ë°°ê²½ */
            --background-medium: #E8E8E8; /* ì¤‘ê°„ ë°ê¸° ë°°ê²½ (ì¹´ë“œ/ëª¨ë‹¬ ë“±) */
            --text-dark: #333333; /* ì–´ë‘ìš´ í…ìŠ¤íŠ¸ */
            --text-medium: #555555; /* ì¤‘ê°„ í…ìŠ¤íŠ¸ */
            --border-light: #CCCCCC; /* ì—°í•œ í…Œë‘ë¦¬ */
            --danger-color: #E74C3C; /* ìœ„í—˜/ì´ˆê¸°í™” ìƒ‰ìƒ */
            
            --card-rotation-x: 0deg;
            --card-rotation-y: 0deg;
        }
        
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: var(--background-light); 
            margin: 0; 
            padding: 0; 
            color: var(--text-dark); 
        }

        .container { 
            max-width: 100%; 
            width: 100%; 
            box-sizing: border-box; 
            background-color: var(--background-light); /* ì „ì²´ ë°°ê²½ì€ ë” ë°ê²Œ */
            min-height: 100vh; 
            padding: 20px; 
        }
        header { 
            text-align: center; 
            border-bottom: 2px dashed var(--primary-accent); /* í¬ì¸íŠ¸ ìƒ‰ìƒìœ¼ë¡œ */
            padding-bottom: 15px; 
            margin-bottom: 20px; 
        }
        header h1 { 
            color: var(--primary-accent); /* ì£¼ìš” ê°•ì¡° ìƒ‰ìƒ */
            margin: 0; 
        }
        
        .header-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .header-buttons button {
            background: none; 
            border-radius: 20px; 
            padding: 8px 16px;
            font-size: 14px; 
            cursor: pointer; 
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: bold;
        }
        #view-toggle-button { border: 1px solid var(--secondary-accent); color: var(--secondary-accent); }
        #reset-button { border: 1px solid var(--danger-color); color: var(--danger-color); }
        #data-view-button { border: 1px solid var(--primary-accent); color: var(--primary-accent); }
        .header-buttons button:hover { background-color: var(--secondary-accent); color: var(--background-light); border-color: var(--secondary-accent); }
        #reset-button:hover { background-color: var(--danger-color); color: var(--background-light); border-color: var(--danger-color); }
        #data-view-button:hover { background-color: var(--primary-accent); color: var(--background-light); border-color: var(--primary-accent); }

        .view { display: none; }
        .view.is-active { display: block; }

        .category-section { margin-bottom: 30px; }
        .category-title { font-size: 1.8em; color: var(--primary-accent); margin-left: 15px; margin-bottom: 15px; }
        .coupon-row { 
            display: flex; 
            overflow-x: auto; 
            padding: 10px; 
            scroll-snap-type: x mandatory; 
            scrollbar-width: none; 
            -ms-overflow-style: none; 
        }
        .coupon-row::-webkit-scrollbar { display: none; }
        
        /* --- ìˆ˜ì •ëœ ë¶€ë¶„ --- */
        .coupon-row.has-active-card {
            overflow: visible; /* í™œì„±í™”ëœ ì¹´ë“œê°€ ìˆì„ ë•Œ ì˜ë¦¬ì§€ ì•Šë„ë¡ í•¨ */
        }
        
        /* ë± ëª¨ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
        .deck-section { margin-bottom: 25px; }
        .deck-section-title { font-size: 1.2em; color: var(--text-dark); margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid var(--secondary-accent); }
        .deck-row { display: flex; flex-wrap: wrap; gap: 10px; }
        .deck-card { 
            width: 120px; aspect-ratio: 1 / 1.4; border-radius: 8px; 
            background: var(--background-medium); /* ë°°ê²½ì„ ë°ê²Œ */
            border: 1px solid var(--border-light); /* ì—°í•œ í…Œë‘ë¦¬ ì¶”ê°€ */
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; 
            padding: 10px; box-sizing: border-box; font-size: 14px; font-weight: bold; 
            color: var(--text-dark); /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘¡ê²Œ */
            position: relative; overflow: hidden; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* ê·¸ë¦¼ìë¥¼ ì—°í•˜ê²Œ */
            cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;
        }
        .deck-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); } /* í˜¸ë²„ íš¨ê³¼ ê°•í™” */
        .deck-card.used { 
            opacity: 0.7; 
            filter: grayscale(60%); 
            background: linear-gradient(135deg, var(--background-medium), var(--border-light)); /* ì‚¬ìš© ì™„ë£ŒëŠ” ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ ì¶”ê°€ */
            color: var(--text-medium); /* í…ìŠ¤íŠ¸ ìƒ‰ìƒë„ ì—°í•˜ê²Œ */
        }
        .deck-card.used::after { 
            content: 'USED'; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) rotate(-20deg); 
            font-size: 1.6em; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
            font-weight: bold; 
            color: rgba(0, 0, 0, 0.3); /* USED í…ìŠ¤íŠ¸ë¥¼ ì–´ë‘¡ê³  íˆ¬ëª…í•˜ê²Œ */
            border: 2px solid rgba(0, 0, 0, 0.3); /* í…Œë‘ë¦¬ë„ ì–´ë‘¡ê³  íˆ¬ëª…í•˜ê²Œ */
            padding: 2px 8px; border-radius: 5px; 
            background-color: rgba(255, 255, 255, 0.5); /* í°ìƒ‰ ë°°ê²½ìœ¼ë¡œ ê°€ë…ì„± í–¥ìƒ */
        }
        
        .coupon { 
            flex-shrink: 0; width: 250px; height: 350px; margin: 0 15px; 
            cursor: pointer; position: relative; background-color: transparent; 
            perspective: 1000px; scroll-snap-align: center; 
            transition: transform 0.5s ease-in-out, opacity 0.5s; 
            transform: rotateY(var(--card-rotation-y)) rotateX(var(--card-rotation-x)); 
            transform-origin: center center; /* í™•ëŒ€ ì¤‘ì‹¬ì  ì„¤ì • */
            border-radius: 15px; /* ì¹´í…Œê³ ë¦¬ ë·° ì¿ í°ì—ë„ ë¼ìš´ë”© ì ìš© */
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); /* ê·¸ë¦¼ì ì¶”ê°€ */
        }
        .coupon.is-active {
            z-index: 100;
        }

        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .coupon.used .card-inner { opacity: 0.7; filter: grayscale(60%); transition: opacity 0.6s, filter 0.6s; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { 
            position: absolute; width: 100%; height: 100%; 
            -webkit-backface-visibility: hidden; backface-visibility: hidden; 
            border-radius: 15px; overflow: hidden; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ, ë‚´ìš© ì•ˆì˜ë¦¬ê²Œ */
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; padding: 20px; box-sizing: border-box; 
            border: 1px solid var(--border-light); /* í…Œë‘ë¦¬ ì¶”ê°€ */
        }
        .card-front { 
            background: linear-gradient(135deg, var(--secondary-accent), var(--primary-accent)); /* ë°ê³  ì‚°ëœ»í•œ ê·¸ë¼ë°ì´ì…˜ */
            transform: rotateY(0deg) translateZ(1px); 
            color: var(--background-light); /* í…ìŠ¤íŠ¸ëŠ” ë°ì€ ë°°ê²½ìƒ‰ìœ¼ë¡œ */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .card-front h3 { margin: 0; font-size: 1.8em; z-index: 1; } /* í°íŠ¸ í¬ê¸° í‚¤ì›€ */

        .coupon.used .card-front::after {
            content: 'USED'; /* í‘œì‹œë  í…ìŠ¤íŠ¸ */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-25deg); /* ì¤‘ì•™ ì •ë ¬ í›„ íšŒì „ */
            font-size: 3em; /* ê¸€ì í¬ê¸°ë¥¼ ì¹´ë“œì— ë§ê²Œ í‚¤ì›€ */
            font-weight: bold;
            color: rgba(255, 255, 255, 0.3); /* ë„ì¥ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            border: 4px solid rgba(255, 255, 255, 0.3); /* ë„ì¥ í…Œë‘ë¦¬ */
            padding: 5px 15px; /* ë‚´ë¶€ ì—¬ë°± */
            border-radius: 10px; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            z-index: 2; /* ì œëª© ìœ„ì— í‘œì‹œ */
        }


        .card-back { 
            background-color: var(--background-medium); /* ë°ì€ ë°°ê²½ìƒ‰ */
            color: var(--text-dark); /* ì–´ë‘ìš´ í…ìŠ¤íŠ¸ */
            justify-content: space-around; position: relative; 
            transform: rotateY(180deg) translateZ(1px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); /* ë’·ë©´ë„ ê·¸ë¦¼ì */
        }
        .card-back > * { position: relative; z-index: 1; color: inherit; }
        .card-back h2 { font-size: 1.8em; color: var(--primary-accent) !important; margin-bottom: 10px; } /* í°íŠ¸ í¬ê¸° ë° ìƒ‰ìƒ */
        .card-back p { font-size: 1.1em; color: var(--text-medium) !important; line-height: 1.5; padding: 0 10px;} /* í°íŠ¸ í¬ê¸° ë° ìƒ‰ìƒ */
        .card-back .used-date { font-size: 0.9em; color: var(--text-medium) !important; margin-top: 5px; }
        .card-back .use-coupon-button { 
            background-color: var(--primary-accent); 
            color: var(--background-light); /* ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ë°ê²Œ */
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 17px; 
            margin-top: 15px; 
            font-weight: bold; 
            transition: background-color 0.3s, transform 0.2s;
        }
        .card-back .use-coupon-button:hover { 
            background-color: var(--danger-color); /* ì‚¬ìš© ë²„íŠ¼ í˜¸ë²„ ì‹œ ì£¼ì˜ ìƒ‰ìƒìœ¼ë¡œ */
            transform: translateY(-2px);
        }
        .card-back .card-close-button { 
            color: var(--text-medium); /* ë‹«ê¸° ë²„íŠ¼ ìƒ‰ìƒ ì¡°ì • */
            position: absolute; top: 10px; right: 20px; 
            font-size: 32px; font-weight: bold; cursor: pointer; 
            transition: color 0.3s;
        }
        .card-back .card-close-button:hover { color: var(--primary-accent); }
        
        .coupon.is-active .card-front,
        .coupon.is-active .card-back {
            overflow: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            border: none; /* í™•ëŒ€ ì‹œ í…Œë‘ë¦¬ ì œê±° (ë” ê¹”ë”í•˜ê²Œ) */
        }

        .coupon.used.is-active .card-inner {
            opacity: 1;
            filter: none;
        }

        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); /* ì˜¤ë²„ë ˆì´ ìƒ‰ìƒ ì¡°ì • */
            display: none; z-index: 99; opacity: 0; transition: opacity 0.5s; 
        }
        #overlay.is-active { display: block; opacity: 1; }

        .modal { display: none; position: fixed; z-index: 101; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { 
            background-color: var(--background-medium); /* ëª¨ë‹¬ ë°°ê²½ë„ ë°ê²Œ */
            margin: 10% auto; /* ëª¨ë‹¬ ìœ„ì¹˜ ì•½ê°„ ìœ„ë¡œ ì¡°ì • */
            padding: 25px; 
            border: 1px solid var(--secondary-accent); 
            border-radius: 12px; 
            width: 90%; max-width: 650px; /* ëª¨ë‹¬ í¬ê¸° ì•½ê°„ í‚¤ì›€ */
            position: relative; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .modal-content .close-button { 
            color: var(--text-medium); 
            position: absolute; top: 10px; right: 20px; 
            font-size: 32px; font-weight: bold; cursor: pointer; 
            transition: color 0.3s;
        }
        .modal-content .close-button:hover { color: var(--primary-accent); }
        #data-json-output { 
            background-color: #222; /* ì½”ë“œ ë¸”ë¡ì€ ì–´ë‘¡ê²Œ ìœ ì§€ */
            color: var(--secondary-accent); /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì¡°ì • */
            padding: 18px; 
            border-radius: 5px; 
            height: 45vh; /* ë†’ì´ ì•½ê°„ ëŠ˜ë¦¼ */
            overflow-y: auto; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-size: 15px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>â¤ï¸ ìš°ë¦¬ë§Œì˜ ì¿ í°ë¶ â¤ï¸</h1>
            <p>ì‚¬ë‘í•˜ëŠ” ìê¸°ì—ê²Œ ì£¼ëŠ” ì„ ë¬¼</p>
            <div class="header-buttons">
                <button id="permission-button" style="display:none;">âœ¨ ìì´ë¡œ íš¨ê³¼ ì¼œê¸°</button>
                <button id="view-toggle-button">ì¿ í° ë± ë³´ê¸° ğŸ—‚ï¸</button>
                <button id="reset-button">ë°ì´í„° ì´ˆê¸°í™” â™»ï¸</button>
                <button id="data-view-button">ë°ì´í„° ë³´ê¸° ğŸ“ˆ</button>
            </div>
        </header>

        <main id="category-view" class="view is-active"></main>
        <div id="deck-view" class="view"></div>
    </div>
    <div id="overlay"></div>

    <div id="data-modal" class="modal">
        <div class="modal-content">
            <span id="data-modal-close" class="close-button">&times;</span>
            <h2>ì¿ í° ë°ì´í„° (localStorage)</h2>
            <pre id="data-json-output"></pre>
        </div>
    </div>
    
    <script>
        const initialCoupons = [
            { category: "ğŸ’– íŠ¹ë³„í•œ ë‚ ", title: "ì†Œì› ë“¤ì–´ì£¼ê¸°", description: "ìê¸°ì˜ ì†Œì› í•œ ê°€ì§€ë¥¼ ì •ì„±ê» ë“¤ì–´ì¤„ê²Œ â¤ï¸", image: "https://images.unsplash.com/photo-1593108526375-27c98d89552a?q=80&w=800", used: false, used_date: null },
            { category: "ğŸ’– íŠ¹ë³„í•œ ë‚ ", title: "1ì¼ ììœ ì´ìš©ê¶Œ", description: "ì˜¤ëŠ˜ í•˜ë£¨ ìê¸°ê°€ í•˜ê³  ì‹¶ì€ ê±° ë‹¤ í•´!", image: "https://images.unsplash.com/photo-1512993245421-65A0a7a40f8a?q=80&w=800", used: false, used_date: null },
            { category: "ğŸ½ï¸ ë§›ìˆëŠ” í•˜ë£¨", title: "ìµœê³ ê¸‰ ì €ë… ì‹ì‚¬", description: "ìê¸°ê°€ ì¢‹ì•„í•˜ëŠ” ë§›ìˆëŠ” ìŒì‹ìœ¼ë¡œ ëŒ€ì ‘í• ê²Œ!", image: "https://images.unsplash.com/photo-1555939594-58d7cb561ad1?q=80&w=800", used: false, used_date: null },
            { category: "ğŸ½ï¸ ë§›ìˆëŠ” í•˜ë£¨", title: "ì¹˜í‚¨ & ë§¥ì£¼", description: "ì˜¤ëŠ˜ ë°¤ì€ ì¹˜ë§¥ì´ë‹¤! ğŸ—ğŸº", image: "https://images.unsplash.com/photo-1562967916-eb82221dfb92?q=80&w=800", used: false, used_date: null },
            { category: "ğŸ’‘ ì†Œì†Œí•œ í–‰ë³µ", title: "ì•ˆë§ˆ 30ë¶„", description: "í”¼ê³¤í•œ ìê¸°ë¥¼ ìœ„í•´ ì‚¬ë‘ì„ ë‹´ì•„ ì•ˆë§ˆí•´ì¤„ê²Œ!", image: "https://images.unsplash.com/photo-1519824145371-296894a0d72b?q=80&w=800", used: false, used_date: null },
            { category: "ğŸ’‘ ì†Œì†Œí•œ í–‰ë³µ", title: "ì˜í™”ê´€ ë°ì´íŠ¸", description: "ë³´ê³  ì‹¶ì€ ì˜í™” ê°™ì´ ë³´ëŸ¬ ê°€ì!", image: "https://images.unsplash.com/photo-1626814026339-a79470989f59?q=80&w=800", used: false, used_date: null },
            { category: "ğŸš¨ ê¸´ê¸‰ìƒí™©", title: "í™” í’€ì–´ì£¼ê¸°", description: "ë‚´ê°€ ì˜ëª»í–ˆì„ ë•Œ ë³´ì—¬ì£¼ë©´ ë¬´ì¡°ê±´ ì‚¬ê³¼í• ê²Œ ğŸ™", image: "https://images.unsplash.com/photo-1563404287-23c8a0a8b958?q=80&w=800", used: false, used_date: null }
        ];
        
        let coupons = [];
        const categoryView = document.getElementById('category-view');
        const deckView = document.getElementById('deck-view');
        const viewToggleButton = document.getElementById('view-toggle-button');
        const overlay = document.getElementById('overlay');
        const permissionButton = document.getElementById('permission-button');
        const resetButton = document.getElementById('reset-button');
        const dataViewButton = document.getElementById('data-view-button');
        const dataModal = document.getElementById('data-modal');
        const dataModalClose = document.getElementById('data-modal-close');
        const dataJsonOutput = document.getElementById('data-json-output');

        function saveCoupons(couponsData) {
            localStorage.setItem('ourCouponData', JSON.stringify(couponsData));
        }

        function loadCoupons() {
            const savedData = localStorage.getItem('ourCouponData');
            if (savedData) {
                return JSON.parse(savedData);
            } else {
                saveCoupons(initialCoupons);
                return initialCoupons;
            }
        }

        function renderCategoryView() {
            categoryView.innerHTML = '';
            const categories = [...new Set(coupons.map(c => c.category))];
            
            categories.forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.classList.add('category-section');
                
                const categoryTitle = document.createElement('h2');
                categoryTitle.classList.add('category-title');
                categoryTitle.textContent = category;
                categorySection.appendChild(categoryTitle);

                const couponRow = document.createElement('div');
                couponRow.classList.add('coupon-row');

                coupons.filter(c => c.category === category).forEach(coupon => {
                    const couponDiv = document.createElement('div');
                    couponDiv.classList.add('coupon');
                    couponDiv.dataset.couponTitle = coupon.title;
                    if (coupon.used) couponDiv.classList.add('used');

                    const cardInner = document.createElement('div');
                    cardInner.classList.add('card-inner');
                    
                    const cardFront = document.createElement('div');
                    cardFront.classList.add('card-front');
                    const title = document.createElement('h3');
                    title.textContent = coupon.title;
                    cardFront.appendChild(title);

                    const cardBack = document.createElement('div');
                    cardBack.classList.add('card-back');
                    
                    const closeButton = document.createElement('span');
                    closeButton.classList.add('card-close-button');
                    closeButton.innerHTML = '&times;';
                    closeButton.addEventListener('click', (e) => { e.stopPropagation(); closeActiveCard(); });
                    cardBack.appendChild(closeButton);

                    const backTitle = document.createElement('h2');
                    backTitle.textContent = coupon.title;

                    const backDesc = document.createElement('p');
                    backDesc.textContent = coupon.description;
                    
                    cardBack.appendChild(backTitle);
                    cardBack.appendChild(backDesc);

                    if (coupon.used) {
                        if (coupon.used_date) {
                            const usedDateText = document.createElement('p');
                            usedDateText.classList.add('used-date');
                            const usedDate = new Date(coupon.used_date);
                            const formattedDate = `${usedDate.getFullYear()}ë…„ ${usedDate.getMonth() + 1}ì›” ${usedDate.getDate()}ì¼ ${usedDate.getHours()}ì‹œ ${usedDate.getMinutes()}ë¶„`;
                            usedDateText.textContent = `ì‚¬ìš© ì™„ë£Œ: ${formattedDate}`;
                            cardBack.appendChild(usedDateText);
                        }
                    } else {
                        const useButton = document.createElement('button');
                        useButton.classList.add('use-coupon-button');
                        useButton.textContent = 'ì¿ í° ì‚¬ìš©í•˜ê¸°';
                        useButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm("ì •ë§ë¡œ ì´ ì¿ í°ì„ ì‚¬ìš©í•˜ì‹œê² ì–´ìš”?")) {
                                const index = coupons.findIndex(c => c.title === coupon.title);
                                if (index !== -1) {
                                    coupons[index].used = true;
                                    coupons[index].used_date = new Date().toISOString();
                                    saveCoupons(coupons);
                                    closeActiveCard();
                                    // ë·°ê°€ ë‹¤ì‹œ ë Œë”ë§ë  ë•Œ ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„ ì‹¤í–‰ë˜ë„ë¡ ì§€ì—°ì‹œê°„ ì¶”ê°€
                                    setTimeout(() => {
                                        if (categoryView.classList.contains('is-active')) renderCategoryView();
                                        if (deckView.classList.contains('is-active')) renderDeckView();
                                    }, 500);
                                }
                            }
                        });
                        cardBack.appendChild(useButton);
                    }
                    
                    cardInner.appendChild(cardFront);
                    cardInner.appendChild(cardBack);
                    couponDiv.appendChild(cardInner);
                    couponRow.appendChild(couponDiv);
                });
                categorySection.appendChild(couponRow);
                categoryView.appendChild(categorySection);
            });
        }

        function renderDeckView() {
            deckView.innerHTML = '';
            const availableSection = document.createElement('div');
            availableSection.classList.add('deck-section');
            const availableTitle = document.createElement('h3');
            availableTitle.classList.add('deck-section-title');
            availableTitle.textContent = 'ì‚¬ìš© ê°€ëŠ¥ ì¿ í°';
            const availableRow = document.createElement('div');
            availableRow.classList.add('deck-row');
            coupons.filter(c => !c.used).forEach(coupon => {
                const card = document.createElement('div');
                card.classList.add('deck-card');
                card.dataset.couponTitle = coupon.title; // ë± ì¹´ë“œì™€ ë©”ì¸ ì¹´ë“œ ì—°ê²°
                
                // ë± ëª¨ë“œ ì¹´ë“œì— ë‚´ìš© ì¶”ê°€ (ì•ë©´ ë¯¸ë¦¬ë³´ê¸°)
                const cardTitle = document.createElement('span');
                cardTitle.textContent = coupon.title;
                card.appendChild(cardTitle);

                availableRow.appendChild(card);
            });
            availableSection.appendChild(availableTitle);
            availableSection.appendChild(availableRow);
            deckView.appendChild(availableSection);

            const usedCoupons = coupons.filter(c => c.used);
            if (usedCoupons.length > 0) {
                const usedSection = document.createElement('div');
                usedSection.classList.add('deck-section');
                const usedTitle = document.createElement('h3');
                usedTitle.classList.add('deck-section-title');
                usedTitle.textContent = 'ì‚¬ìš© ì™„ë£Œ ì¿ í°';
                const usedRow = document.createElement('div');
                usedRow.classList.add('deck-row');
                usedCoupons.forEach(coupon => {
                    const card = document.createElement('div');
                    card.classList.add('deck-card', 'used');
                    card.dataset.couponTitle = coupon.title; // ë± ì¹´ë“œì™€ ë©”ì¸ ì¹´ë“œ ì—°ê²°

                    // ë± ëª¨ë“œ ì¹´ë“œì— ë‚´ìš© ì¶”ê°€ (ë’·ë©´ ë¯¸ë¦¬ë³´ê¸°)
                    const cardTitle = document.createElement('span');
                    cardTitle.textContent = coupon.title;
                    const usedDateText = document.createElement('small');
                    if (coupon.used_date) {
                        const usedDate = new Date(coupon.used_date);
                        usedDateText.textContent = `ì‚¬ìš©: ${usedDate.getMonth() + 1}/${usedDate.getDate()}`;
                    }
                    card.appendChild(cardTitle);
                    card.appendChild(usedDateText);

                    usedRow.appendChild(card);
                });
                usedSection.appendChild(usedTitle);
                usedSection.appendChild(usedRow);
                deckView.appendChild(usedSection);
            }
        }
        
        function openCard(cardElement) {
            if (document.querySelector('.coupon.is-active')) return;

            // --- ìˆ˜ì •ëœ ë¶€ë¶„ ---
            const couponRow = cardElement.closest('.coupon-row');
            if (couponRow) {
                couponRow.classList.add('has-active-card');
            }

            const cardInner = cardElement.querySelector('.card-inner');
            overlay.classList.add('is-active');
            
            // ğŸš€ ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ ë¡œì§
            const rect = cardElement.getBoundingClientRect(); // ì¹´ë“œì˜ í˜„ì¬ ìœ„ì¹˜ì™€ í¬ê¸°

            // ğŸ’¡ 3. ì¿ í°ì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ í™•ëŒ€ ë¹„ìœ¨ ë° ìœ„ì¹˜ ì¡°ì •
            // í™”ë©´ì˜ 90%ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ìµœëŒ€ í¬ê¸°ë¥¼ ì„¤ì •
            const maxScaleX = (window.innerWidth * 0.9) / rect.width;
            const maxScaleY = (window.innerHeight * 0.9) / rect.height;
            const scale = Math.min(maxScaleX, maxScaleY, 1.5); // ìµœëŒ€ 1.5ë°° í™•ëŒ€, í™”ë©´ ë¹„ìœ¨ ê³ ë ¤

            const translateX = (window.innerWidth / 2) - (rect.left + rect.width / 2); // í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ì´ë™í•  Xê°’
            const translateY = (window.innerHeight / 2) - (rect.top + rect.height / 2); // í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ì´ë™í•  Yê°’
            
            cardElement.style.transition = 'transform 0.5s ease-in-out'; // transitionì„ JSì—ì„œ ì œì–´
            cardElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale}) rotateY(var(--card-rotation-y)) rotateX(var(--card-rotation-x))`;
            cardElement.classList.add('is-active');

            // ì‚¬ìš©ëœ ì¿ í°ì€ ë°”ë¡œ ë’·ë©´, ì•„ë‹ˆë©´ ì•ë©´ -> ë’·ë©´ìœ¼ë¡œ í”Œë¦½
            const isUsed = cardElement.classList.contains('used');
            if(isUsed) {
                cardInner.style.transition = 'none'; // í”Œë¦½ ì• ë‹ˆë©”ì´ì…˜ ì—†ì´
                cardInner.classList.add('is-flipped');
                setTimeout(() => { cardInner.style.transition = ''; }, 0); // ì¦‰ì‹œ transition ë³µì›
            } else {
                 cardInner.classList.add('is-flipped');
            }
        }

        function closeActiveCard() {
            const activeCard = document.querySelector('.coupon.is-active');
            if (activeCard) {
                // --- ìˆ˜ì •ëœ ë¶€ë¶„ ---
                const couponRow = activeCard.closest('.coupon-row');
                if (couponRow) {
                    couponRow.classList.remove('has-active-card');
                }

                overlay.classList.remove('is-active');
                
                // ğŸš€ ì›ë˜ ìœ„ì¹˜ë¡œ ëŒì•„ê°€ëŠ” ì• ë‹ˆë©”ì´ì…˜
                activeCard.style.transform = `translate(0, 0) scale(1) rotateY(var(--card-rotation-y)) rotateX(var(--card-rotation-x))`;
                
                setTimeout(() => {
                    activeCard.classList.remove('is-active');
                    activeCard.style.transition = ''; // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì œê±°
                    activeCard.style.transform = '';
                    // ì¹´í…Œê³ ë¦¬ ë·°ê°€ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ë Œë”ë§ (ë± ë·°ì—ì„œ ì—´ì—ˆì„ ê²½ìš° ì¹´í…Œê³ ë¦¬ ë·°ê°€ ê°±ì‹ ë˜ë©´ ì•ˆë¨)
                    if (categoryView.classList.contains('is-active')) {
                        renderCategoryView(); 
                    }
                    if (deckView.classList.contains('is-active')) {
                        renderDeckView(); // ë± ë·°ì—ì„œë„ ì‚¬ìš© ì—¬ë¶€ ì¦‰ì‹œ ë°˜ì˜
                    }
                }, 500); // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ê³¼ ì¼ì¹˜
                
                activeCard.querySelector('.card-inner').classList.remove('is-flipped');
            }
        }

        function handleOrientation(event) {
            const { beta, gamma } = event;
            const rotateX = (beta - 45) * 0.3;
            const rotateY = gamma * 0.3;
            const allCoupons = document.querySelectorAll('.coupon:not(.is-active)');
            allCoupons.forEach(coupon => {
                coupon.style.setProperty('--card-rotation-x', `${rotateX}deg`);
                coupon.style.setProperty('--card-rotation-y', `${rotateY}deg`);
            });
        }

        function initializeApp() {
            coupons = loadCoupons();
            renderCategoryView(); // í•­ìƒ ì¹´í…Œê³ ë¦¬ ë·°ë¥¼ ë¨¼ì € ë Œë”ë§í•´ì„œ DOMì— ìš”ì†Œë¥¼ ë§Œë“¤ì–´ ë‘ 

            viewToggleButton.addEventListener('click', () => {
                const isCategoryViewActive = categoryView.classList.contains('is-active');
                if (isCategoryViewActive) {
                    categoryView.classList.remove('is-active');
                    deckView.classList.add('is-active');
                    viewToggleButton.innerHTML = 'ì¹´í…Œê³ ë¦¬ ë³´ê¸° ğŸ“–';
                    renderDeckView(); // ë± ë·°ë¡œ ì „í™˜ ì‹œ ë± ë·° ë Œë”ë§
                } else {
                    deckView.classList.remove('is-active');
                    categoryView.classList.add('is-active');
                    viewToggleButton.innerHTML = 'ì¿ í° ë± ë³´ê¸° ğŸ—‚ï¸';
                    renderCategoryView(); // ì¹´í…Œê³ ë¦¬ ë·°ë¡œ ì „í™˜ ì‹œ ì¹´í…Œê³ ë¦¬ ë·° ë Œë”ë§ (ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
                }
            });

            resetButton.addEventListener('click', () => {
                if (confirm("ì •ë§ë¡œ ëª¨ë“  ì¿ í° ë°ì´í„°ë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ì‹œê² ì–´ìš”? ì‚¬ìš© ê¸°ë¡ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) {
                    localStorage.removeItem('ourCouponData');
                    location.reload();
                }
            });

            dataViewButton.addEventListener('click', () => {
                const currentData = localStorage.getItem('ourCouponData');
                const prettyJson = JSON.stringify(JSON.parse(currentData), null, 2);
                dataJsonOutput.textContent = prettyJson;
                dataModal.style.display = 'block';
            });
            
            dataModalClose.addEventListener('click', () => { dataModal.style.display = 'none'; });
            
            window.addEventListener('click', (event) => {
                if (event.target == dataModal) {
                    dataModal.style.display = 'none';
                }
            });

            overlay.addEventListener('click', closeActiveCard);

            categoryView.addEventListener('click', (event) => {
                const couponDiv = event.target.closest('.coupon');
                if (couponDiv) {
                    openCard(couponDiv);
                }
            });
            
            // ë± ë·°ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            deckView.addEventListener('click', (event) => {
                const deckCard = event.target.closest('.deck-card');
                if (deckCard) {
                    const title = deckCard.dataset.couponTitle;
                    // ë± ë·°ì—ì„œ ì¹´í…Œê³ ë¦¬ ë·°ë¡œ ì „í™˜
                    if (!categoryView.classList.contains('is-active')) {
                        deckView.classList.remove('is-active');
                        categoryView.classList.add('is-active');
                        viewToggleButton.innerHTML = 'ì¿ í° ë± ë³´ê¸° ğŸ—‚ï¸';
                        renderCategoryView(); // ì¹´í…Œê³ ë¦¬ ë·° ë Œë”ë§
                    }

                    // ì¹´í…Œê³ ë¦¬ ë·°ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ í•´ë‹¹ ì¿ í°ì„ ì¤‘ì•™ì— ìœ„ì¹˜ì‹œí‚¨ í›„ í™•ëŒ€
                    setTimeout(() => { // ë·° ì „í™˜ í›„ DOM ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ì•½ê°„ì˜ ì§€ì—°
                        const correspondingCoupon = categoryView.querySelector(`.coupon[data-coupon-title="${title}"]`);
                        if (correspondingCoupon) {
                            correspondingCoupon.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                            // ìŠ¤í¬ë¡¤ ì™„ë£Œ í›„ í™•ëŒ€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                            setTimeout(() => openCard(correspondingCoupon), 500); // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ê³¼ ì¼ì¹˜
                        }
                    }, 100); // ë·° ì „í™˜ í›„ DOMì´ ì™„ì „íˆ ì¤€ë¹„ë  ì‹œê°„
                }
            });

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                permissionButton.style.display = 'block';
                permissionButton.addEventListener('click', () => {
                    DeviceOrientationEvent.requestPermission().then(state => {
                        if (state === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            permissionButton.style.display = 'none';
                        } else {
                            alert('ìì´ë¡œìŠ¤ì½”í”„ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }
                    }).catch(console.error);
                });
            } else if ('DeviceOrientationEvent' in window) {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>